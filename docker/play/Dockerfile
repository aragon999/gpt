ARG BASE_IMAGE=gptdev/base

FROM ${BASE_IMAGE} AS build

ARG COMPILER=gcc
ARG MPI=none

# TODO: Add libopenmpi3 openmpi-bin mpich libmpich12 if we enable mpi, maybe
#       only for the images built with MPI (file size)
RUN \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
        libfftw3-double3 libfftw3-single3 libomp5-9 libmpfr6 libopenmpi3 && \
    rm -rf /var/lib/apt/lists/*

COPY gpt-packages/python-gpt-Linux-python-3.8-${COMPILER}-${MPI}.deb /app/

RUN \
    dpkg -i python-gpt-Linux-python-3.8-${COMPILER}-${MPI}.deb && \
    rm python-gpt-Linux-python-3.8-${COMPILER}-${MPI}.deb

RUN groupadd -r gpt && \
    useradd --no-log-init -m -r -g gpt gpt && \
    adduser gpt sudo && \
    echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

FROM scratch
COPY --from=build / /

WORKDIR /app

USER gpt
VOLUME /gpt-code

ENV PYTHONPATH="/usr/local/lib/python3.8/site-packages:${PYTHONPATH}"
ENV PATH="/app/bin:/home/gpt/.local/bin:${PATH}"

CMD ["/bin/bash"]
